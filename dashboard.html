<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© - ØªØ¹Ù„ÙŠÙ… Ø¹Ø³ÙŠØ±</title>
    <link rel="stylesheet" href="style.css?v=1.5">
    <style>
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { padding: 20px; border-radius: 12px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .bg-total { background: #007bff; } .bg-boys { background: #28a745; } .bg-girls { background: #e83e8c; }
        .bg-done { background: #ffc107; color: #333; } .bg-pending { background: #dc3545; }
        .progress-container { background: #f0f0f0; border-radius: 10px; height: 30px; margin: 20px 0; overflow: hidden; position: relative; }
        .progress-bar { background: #155724; height: 100%; transition: width 0.5s ease-in-out; }
        .progress-text { position: absolute; width: 100%; text-align: center; top: 5px; font-weight: bold; color: #000; }
        select { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 20px; font-size: 1rem; }
        .download-section { text-align: center; margin-top: 20px; }
        .btn-download { background: #17a2b8; color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-download:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Ù„ÙˆØ­Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h1>
            <p>Ù‚Ø³Ù… Ø§Ù„Ø£Ù…Ù† ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„Ù…Ø±Ø§ÙÙ‚</p>
        </div>

        <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…ØªØ§Ø¨Ø¹:</label>
        <select id="supervisorSelect">
            <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</option>
        </select>

        <div class="stats-grid">
            <div class="card bg-total"><h4>Ø§Ù„ÙƒÙ„ÙŠ</h4><h2 id="totalCount">0</h2></div>
            <div class="card bg-boys"><h4>Ø¨Ù†ÙŠÙ†</h4><h2 id="boysCount">0</h2></div>
            <div class="card bg-girls"><h4>Ø¨Ù†Ø§Øª</h4><h2 id="girlsCount">0</h2></div>
            <div class="card bg-done"><h4>Ù…ÙƒØªÙ…Ù„</h4><h2 id="doneCount">0</h2></div>
            <div class="card bg-pending"><h4>Ù…ØªØ¨Ù‚ÙŠ</h4><h2 id="pendingCount">0</h2></div>
        </div>

        <div class="section">
            <h3>ğŸ“ˆ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</h3>
            <div class="progress-container">
                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                <div id="progressText" class="progress-text">0%</div>
            </div>
        </div>

        <div class="download-section">
            <button id="downloadBtn" class="btn-download" disabled>ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ØºÙŠØ± Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</button>
        </div>

        <div id="loadingSpinner" class="spinner hidden"></div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx1_xZaPHomeGg40rrPAokN68-4nKVMi3IvBdOnVWOt2S4NSsZhQykdmf-yhBLMkizHgw/exec";
        let currentPendingList = [];

        async function fetchStats(supervisor = "all") {
            const spinner = document.getElementById("loadingSpinner");
            spinner.classList.remove("hidden");
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getStats&supervisor=${encodeURIComponent(supervisor)}`);
                const data = await response.json();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
                document.getElementById("totalCount").textContent = data.total;
                document.getElementById("boysCount").textContent = data.boys;
                document.getElementById("girlsCount").textContent = data.girls;
                document.getElementById("doneCount").textContent = data.completed;
                document.getElementById("pendingCount").textContent = data.pending;
                
                // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                const percent = data.total > 0 ? Math.round((data.completed / data.total) * 100) : 0;
                document.getElementById("progressBar").style.width = percent + "%";
                document.getElementById("progressText").textContent = percent + "%";
                
                // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
                if (document.getElementById("supervisorSelect").options.length === 1) {
                    data.supervisors.forEach(s => {
                        let opt = document.createElement("option");
                        opt.value = s; opt.textContent = s;
                        document.getElementById("supervisorSelect").appendChild(opt);
                    });
                }

                // Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ¹Ø«Ø±ÙŠÙ† Ù„Ù„ØªÙ†Ø²ÙŠÙ„
                currentPendingList = data.pendingList;
                document.getElementById("downloadBtn").disabled = currentPendingList.length === 0;

            } catch (e) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            } finally {
                spinner.classList.add("hidden");
            }
        }

        // Ø¯Ø§Ù„Ø© ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù CSV
        document.getElementById("downloadBtn").onclick = () => {
            if (currentPendingList.length === 0) return;
            
            let csvContent = "\ufeffØ§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©,Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ²Ø§Ø±ÙŠ,Ø§Ù„Ù…Ø¯ÙŠØ±,Ø§Ù„Ø¬ÙˆØ§Ù„\n";
            currentPendingList.forEach(row => {
                csvContent += `${row.name},${row.number},${row.principal},${row.phone}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Ù…ØªØ¹Ø«Ø±ÙŠÙ†_${document.getElementById("supervisorSelect").value}.csv`);
            link.click();
        };

        document.getElementById("supervisorSelect").onchange = (e) => fetchStats(e.target.value);

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        window.onload = () => fetchStats();
    </script>
</body>
</html>