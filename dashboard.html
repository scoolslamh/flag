<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© - ØªØ¹Ù„ÙŠÙ… Ø¹Ø³ÙŠØ±</title>
    <link rel="stylesheet" href="style.css?v=1.6">
    <style>
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØ§Ù„ÙƒØ±ÙˆØª */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { padding: 20px; border-radius: 12px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .bg-total { background: #007bff; } .bg-boys { background: #28a745; } .bg-girls { background: #e83e8c; }
        .bg-done { background: #ffc107; color: #333; } .bg-pending { background: #dc3545; }
        
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
        .progress-container { background: #f0f0f0; border-radius: 10px; height: 30px; margin: 20px 0; overflow: hidden; position: relative; }
        .progress-bar { background: #155724; height: 100%; transition: width 0.5s ease-in-out; }
        .progress-text { position: absolute; width: 100%; text-align: center; top: 5px; font-weight: bold; color: #000; }
        
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆØ± Ø¨Ø§Ù„Ø¥Ø·Ø§Ø± */
        select { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 20px; font-size: 1rem; }
        
        .table-container { 
            margin-top: 30px; 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            display: none; 
            
            /* ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø·Ø§Ø± ÙˆØ§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ */
            max-height: 500px; 
            overflow-y: auto; 
            border: 1px solid #eee;
        }

        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        
        /* ØªØ«Ø¨ÙŠØª Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        th { 
            background-color: #f8f9fa; 
            color: #333; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            border-bottom: 2px solid #dee2e6;
            box-shadow: 0 2px 2px -1px rgba(0,0,0,0.05);
        }

        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; font-size: 0.85rem; }
        tr:hover { background-color: #f9f9f9; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ø¹Ø±Ø¶ */
        .btn-display { background: #17a2b8; color: white; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1.1rem; transition: 0.3s; }
        .btn-display:hover:not(:disabled) { background: #138496; }
        .btn-display:disabled { background: #ccc; cursor: not-allowed; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬ÙˆØ§Ù„ */
        .phone-link { color: #007bff; text-decoration: none; font-weight: bold; }

        /* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        .table-container::-webkit-scrollbar { width: 6px; }
        .table-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Ù„ÙˆØ­Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h1>
            <p>Ù‚Ø³Ù… Ø§Ù„Ø£Ù…Ù† ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„Ù…Ø±Ø§ÙÙ‚</p>
        </div>

        <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…ØªØ§Ø¨Ø¹:</label>
        <select id="supervisorSelect">
            <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</option>
        </select>

        <div class="stats-grid">
            <div class="card bg-total"><h4>Ø§Ù„ÙƒÙ„ÙŠ</h4><h2 id="totalCount">0</h2></div>
            <div class="card bg-boys"><h4>Ø¨Ù†ÙŠÙ†</h4><h2 id="boysCount">0</h2></div>
            <div class="card bg-girls"><h4>Ø¨Ù†Ø§Øª</h4><h2 id="girlsCount">0</h2></div>
            <div class="card bg-done"><h4>Ù…ÙƒØªÙ…Ù„</h4><h2 id="doneCount">0</h2></div>
            <div class="card bg-pending"><h4>Ù…ØªØ¨Ù‚ÙŠ</h4><h2 id="pendingCount">0</h2></div>
        </div>

        <div class="section">
            <h3>ğŸ“ˆ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</h3>
            <div class="progress-container">
                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                <div id="progressText" class="progress-text">0%</div>
            </div>
        </div>

        <div class="display-section">
            <button id="displayDataBtn" class="btn-display" disabled>ğŸ‘ï¸ Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…ØªØ¹Ø«Ø±Ø©</button>
        </div>

        <div id="tableWrapper" class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</th>
                        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th>
                        <th>Ø§Ù„Ù…Ø¯ÙŠØ±/Ø©</th>
                        <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                        <th>Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø±Ø³Ù…ÙŠ</th>
                    </tr>
                </thead>
                <tbody id="pendingTableBody">
                </tbody>
            </table>
        </div>

        <div id="loadingSpinner" class="spinner hidden"></div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzBpUd9UPgipcqvvUASp1DxeASeQIiD_bP1hHluHluuj7x1IxzoTvgAlitUGZOuEgd-ZQ/exec";
        let currentPendingList = [];

        async function fetchStats(supervisor = "all") {
            const spinner = document.getElementById("loadingSpinner");
            const tableWrap = document.getElementById("tableWrapper");
            
            spinner.classList.remove("hidden");
            tableWrap.style.display = "none"; 
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getStats&supervisor=${encodeURIComponent(supervisor)}`);
                const data = await response.json();
                
                document.getElementById("totalCount").textContent = data.total;
                document.getElementById("boysCount").textContent = data.boys;
                document.getElementById("girlsCount").textContent = data.girls;
                document.getElementById("doneCount").textContent = data.completed;
                document.getElementById("pendingCount").textContent = data.pending;
                
                const percent = data.total > 0 ? Math.round((data.completed / data.total) * 100) : 0;
                document.getElementById("progressBar").style.width = percent + "%";
                document.getElementById("progressText").textContent = percent + "%";
                
                if (document.getElementById("supervisorSelect").options.length === 1) {
                    data.supervisors.forEach(s => {
                        let opt = document.createElement("option");
                        opt.value = s; opt.textContent = s;
                        document.getElementById("supervisorSelect").appendChild(opt);
                    });
                }

                currentPendingList = data.pendingList;
                const btn = document.getElementById("displayDataBtn");
                btn.disabled = currentPendingList.length === 0;
                btn.textContent = `ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…ØªØ¹Ø«Ø±Ø© (${currentPendingList.length})`;

            } catch (e) {
                alert("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø± Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙƒØ¥ØµØ¯Ø§Ø± Ø¬Ø¯ÙŠØ¯.");
            } finally {
                spinner.classList.add("hidden");
            }
        }

        document.getElementById("displayDataBtn").onclick = () => {
            const tbody = document.getElementById("pendingTableBody");
            const tableWrap = document.getElementById("tableWrapper");
            
            tbody.innerHTML = ""; 

            currentPendingList.forEach(row => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${row.area || "-"}</td>
                    <td>${row.name || "-"}</td>
                    <td>${row.principal || "-"}</td>
                    <td><a href="tel:${row.phone}" class="phone-link">${row.phone || "-"}</a></td>
                    <td><small>${row.email || "-"}</small></td>
                `;
                tbody.appendChild(tr);
            });

            tableWrap.style.display = "block"; 
            
            // ØªÙ…Ø±ÙŠØ± Ø®ÙÙŠÙ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© Ù„Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            tableWrap.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        document.getElementById("supervisorSelect").onchange = (e) => fetchStats(e.target.value);
        window.onload = () => fetchStats();
    </script>
</body>
</html>